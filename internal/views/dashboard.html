<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JejakAPI - Request Monitoring</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              dark: {
                bg: "#0f172a",
                surface: "#1e293b",
                border: "#334155",
                text: "#e2e8f0",
              },
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-dark-bg text-dark-text min-h-screen">
    <!-- Header dengan menu bar -->
    <header class="bg-dark-surface border-b border-dark-border">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <!-- Logo/Title -->
          <div class="flex items-center">
            <h1 class="text-xl font-bold text-white">Jejak API</h1>
          </div>

          <!-- Action Buttons -->
          <div class="flex items-center space-x-4">
            <button
              onclick="toggleEnabled()"
              class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 text-sm font-medium"
            >
              Toggle Monitoring
            </button>
            <button
              onclick="refreshLogs()"
              class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 text-sm font-medium"
            >
              Refresh
            </button>
            <button
              onclick="clearLogs()"
              class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 text-sm font-medium"
            >
              Clear All
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div id="logs-container" class="space-y-4">
        <div class="text-center py-16">
          <div
            class="animate-spin inline-block w-8 h-8 border-[3px] border-current border-t-transparent text-blue-600 rounded-full"
            role="status"
            aria-label="loading"
          >
            <span class="sr-only">Loading...</span>
          </div>
          <p class="mt-4 text-gray-400">Loading logs...</p>
        </div>
      </div>
    </main>

    <script>
      let currentPage = 1;
      const logsPerPage = 20;

      function formatTimestamp(timestamp) {
        return new Date(timestamp).toLocaleString();
      }

      function formatDuration(microseconds) {
        if (microseconds < 1000) {
          return microseconds + "Î¼s";
        } else if (microseconds < 1000000) {
          return Math.round(microseconds / 1000) + "ms";
        } else {
          return Math.round(microseconds / 1000000) + "s";
        }
      }

      function getStatusClass(status) {
        if (status >= 200 && status < 300) return "bg-green-600";
        if (status >= 400) return "bg-red-600";
        if (status >= 300) return "bg-yellow-600";
        return "bg-gray-600";
      }

      function getMethodClass(method) {
        switch (method) {
          case "GET":
            return "bg-green-600";
          case "POST":
            return "bg-blue-600";
          case "PUT":
            return "bg-yellow-600";
          case "DELETE":
            return "bg-red-600";
          case "PATCH":
            return "bg-purple-600";
          default:
            return "bg-gray-600";
        }
      }

      function formatJSON(str) {
        try {
          return JSON.stringify(JSON.parse(str), null, 2);
        } catch (e) {
          return str;
        }
      }

      function toggleLogDetails(id) {
        // window.open("/jejakapi/logs/" + id, "_blank"); // Open detail in new window/tab
        window.location.href = "/jejakapi/logs/" + id; // redirect to detail page
      }

      async function loadLogs(page = 1) {
        try {
          const response = await fetch(
            "/jejakapi/api/logs?page=" + page + "&limit=" + logsPerPage
          );
          const data = await response.json();

          let html = "";

          if (data.logs && data.logs.length > 0) {
            data.logs.forEach((log) => {
              const statusClass = getStatusClass(log.status_code);
              const methodClass = getMethodClass(log.method);

              html += `
                <div class="bg-dark-surface border border-dark-border rounded-lg overflow-hidden hover:bg-slate-700 transition-colors duration-200 cursor-pointer" onclick="toggleLogDetails('${
                  log.id
                }')">
                  <div class="p-4">
                    <div class="flex items-center justify-between">
                      <div class="flex items-center space-x-3">
                        <span class="${methodClass} text-white px-2 py-1 rounded text-xs font-bold">${
                log.method
              }</span>
                        <span class="text-gray-300 font-mono text-sm">${
                          log.url
                        }</span>
                      </div>
                      <div class="flex items-center space-x-3 text-sm">
                        <span class="${statusClass} text-white px-2 py-1 rounded text-xs font-bold">${
                log.status_code
              }</span>
                        <span class="text-gray-400">${formatDuration(
                          log.duration
                        )}</span>
                        <span class="text-gray-500">${formatTimestamp(
                          log.created_at
                        )}</span>
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-1M7 7l10 10M17 7v4"></path>
                        </svg>
                      </div>
                    </div>
                  </div>
                </div>
              `;
            });

            // Add pagination
            const totalPages = Math.ceil(data.total / logsPerPage);
            if (totalPages > 1) {
              html += '<div class="flex justify-center mt-8 space-x-2">';
              for (let i = 1; i <= totalPages; i++) {
                const activeClass =
                  i === page
                    ? "bg-blue-600 text-white"
                    : "bg-dark-surface text-gray-300 hover:bg-slate-700";
                html += `<button onclick="loadLogs(${i})" class="${activeClass} px-3 py-2 rounded border border-dark-border transition-colors duration-200">${i}</button>`;
              }
              html += "</div>";
            }
          } else {
            html = `
              <div class="text-center py-16">
                <div class="text-gray-400 text-lg">No logs found</div>
                <p class="text-gray-500 mt-2">Start making requests to see logs here</p>
              </div>
            `;
          }

          document.getElementById("logs-container").innerHTML = html;
          currentPage = page;
        } catch (error) {
          console.error("Error loading logs:", error);
          document.getElementById("logs-container").innerHTML = `
            <div class="text-center py-16">
              <div class="text-red-400 text-lg">Error loading logs</div>
              <p class="text-gray-500 mt-2">${error.message}</p>
            </div>
          `;
        }
      }

      async function clearLogs() {
        if (confirm("Are you sure you want to clear all logs?")) {
          try {
            await fetch("/jejakapi/api/logs", { method: "DELETE" });
            loadLogs(1);
          } catch (error) {
            console.error("Error clearing logs:", error);
            alert("Error clearing logs: " + error.message);
          }
        }
      }

      async function toggleEnabled() {
        try {
          await fetch("/jejakapi/api/toggle", { method: "POST" });
          // Show a brief notification instead of alert
          const notification = document.createElement("div");
          notification.className =
            "fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50";
          notification.textContent = "Monitoring toggled";
          document.body.appendChild(notification);
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 3000);
        } catch (error) {
          console.error("Error toggling monitoring:", error);
          alert("Error toggling monitoring: " + error.message);
        }
      }

      function refreshLogs() {
        loadLogs(currentPage);
      }

      // Load logs on page load
      document.addEventListener("DOMContentLoaded", function () {
        loadLogs();

        // Auto refresh every 10 seconds
        setInterval(function () {
          if (currentPage === 1) {
            loadLogs(1);
          }
        }, 10000);
      });
    </script>
  </body>
</html>
